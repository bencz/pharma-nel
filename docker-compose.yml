# =============================================================================
# Pharma Knowledge - Development Docker Compose
# =============================================================================
# Usage: docker-compose up -d
#
# Services:
# - api: FastAPI backend with hot-reload
# - frontend: Next.js frontend with hot-reload
# - arangodb: Graph database
#
# Prerequisites:
# - Copy backend/.env.example to backend/.env and configure
# - Set OPENAI_API_KEY environment variable
# =============================================================================

services:
  # =============================================================================
  # Backend
  # =============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: docker/Dockerfile
    ports:
      - "8000:8000"
    environment:
      # ArangoDB connection (Docker network)
      - ARANGO_HOST=http://arangodb:8529
      - ARANGO_DATABASE=pharma_ner
      - ARANGO_USER=${ARANGO_USER:-root}
      - ARANGO_PASSWORD=${ARANGO_PASSWORD:-pharma123}
      # OpenAI (required for NER)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4.1-mini}
      # FDA API (optional - increases rate limits)
      - FDA_API_KEY=${FDA_API_KEY:-}
      # Development settings
      - ENV=development
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - LOG_JSON=false
      # CORS (allow frontend)
      - CORS_ORIGINS=["http://localhost:3000","http://frontend:3000"]
    depends_on:
      - arangodb
    volumes:
      # Mount source for hot-reload
      - ./backend/src:/app/src:ro
      - ./backend/main.py:/app/main.py:ro
    # Development: uvicorn with hot reload
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - pharma-network

  # =============================================================================
  # Next.js Frontend (Development)
  # =============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: docker/Dockerfile.dev
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_PHARMA_API_URL=http://localhost:8000
    volumes:
      # Mount source for hot-reload
      - ./frontend/src:/app/src:ro
      - ./frontend/public:/app/public:ro
    depends_on:
      - backend
    networks:
      - pharma-network

  # =============================================================================
  # ArangoDB (Knowledge Graph)
  # =============================================================================
  arangodb:
    image: arangodb:latest
    ports:
      - "8529:8529"
    environment:
      - ARANGO_ROOT_PASSWORD=${ARANGO_PASSWORD:-pharma123}
    volumes:
      - arango_data:/var/lib/arangodb3
    command: ["arangod", "--server.endpoint", "tcp://0.0.0.0:8529", "--vector-index"]
    networks:
      - pharma-network

volumes:
  arango_data:
    driver: local

networks:
  pharma-network:
    driver: bridge
